<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> pkg-config · Codroc Blog</title><meta name="description" content="pkg-config - Codroc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://codroc.github.io/atom.xml" title="Codroc Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Codroc Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/codroc" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">pkg-config</h1><div class="post-info">2021年3月26日</div><div class="post-content"><h1 id="pkg-config"><a href="#pkg-config" class="headerlink" title="pkg-config"></a>pkg-config</h1><p>这个小工具一般来说需要自己下载，执行 <code>sudo apt install pkg-config</code> 就可以了！</p>
<h1 id="1-命令简介"><a href="#1-命令简介" class="headerlink" title="1. 命令简介"></a>1. 命令简介</h1><p>pkg-config 用于返回安装库的元信息</p>
<p>大家应该都知道一般用第三方库的时候，就少不了要使用到第三方的头文件和库文件。我们在编译、链接的时候，必须要指定这些头文件和库文件的位置。对于一个比较大的第三方库，其头文件和库文件的数量是比较多的，如果我们一个个手动地写，那将是相当的麻烦的。因此，pkg-config就应运而生了。pkg-config能够把这些头文件和库文件的位置指出来，给编译器使用。</p>
<p><strong>pkg-config</strong> 主要提供了下面几个功能：</p>
<ul>
<li>检查库的版本号。 如果所需要的库的版本不满足要求，它会打印出错误信息，避免链接错误版本的库文件</li>
<li>获得编译预处理参数，如宏定义、头文件的位置</li>
<li>获得链接参数，如库及依赖的其他库的位置，文件名及其他一些链接参数</li>
<li>自动加入所依赖的其他库的设置</li>
</ul>
<p>在大多数的系统中呢，<strong>pkg-config</strong> 会去 <code>/usr/lib/pkgconfig，/usr/share/pkgconfig，/usr/local/lib/pkgconfig，/usr/local/share/pkgconfig</code> 中寻找 <code>.pc</code> 后缀的元数据文件（metadata file）。而且不是所有的库安装好后都带有 <code>.pc</code> 文件的。如果 <code>.pc</code> 不在上述的任意一个目录中，那么可以通过往 <strong>PKG_CONFIG_PATH</strong> 环境变量中添加目录，例如：<code>$ export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/opt/pkgconfig</code> </p>
<p>这样 <strong>pkg-config</strong> 就会在 <code>/opt/pkgconfig</code> 目录下寻找 <code>.pc</code> 文件了</p>
<p>另外还需要注意的是,上述环境变量的设置只对当前的终端窗口有效。为了让其永久生效，我们可以将上述命令写入到 <code>/etc/bash.bashrc</code> 等文件中，以方便后续使用</p>
<h1 id="2-注意点"><a href="#2-注意点" class="headerlink" title="2. 注意点"></a>2. 注意点</h1><p>我在之前碰到过一个很奇怪的现象，那就是，通过 <strong>pkg-config</strong> 工具把一个源文件编译并且链接好了（和 so 文件链接）得到了可执行文件。当我执行这个文件的时候却告诉我有申明了却未定义的函数（方法）！这让我很纳闷，明明编译和链接都成功通过了，运行的时候怎么就报未定义的错误了呢？要是有这类错误不是在链接的时候就应该报了吗？我百思不得其解啊！</p>
<p>后来看到别人的博客上写的文章才发现 <strong>pkg-config</strong> 工作在编译时和链接时，它是不管运行时的！也就是说在运行程序的时候，如果需要动态加载共享库（so 文件），就要到系统已知的 so 库目录下去寻找。而如果你的共享库没有在系统已知的 so 库目录下，就会报未定义的错误</p>
<p>可以通过往 <strong>LD_LIBRARY_PATH</strong> 环境变量添加 so 库目录来解决这个问题</p>
<p>这里我们列出pkg-config与LD_LIBRARY_PATH的主要工作阶段：</p>
<ul>
<li>pkg-config: 编译时、 链接时</li>
<li>LD_LIBRARY_PATH: 链接时、 运行时</li>
</ul>
<p>总结：</p>
<p>库文件在链接（静态库和共享库）和运行（仅限于使用共享库的程序）时被使用，其搜索路径是在系统中进行设置的。一般 Linux 系统把 <code>/lib</code> 和 <code>/usr/lib</code> 这两个目录作为默认的库搜索路径，所以使用这两个目录中的库时不需要进行设置搜索路径即可直接使用。对于处于默认库搜索路径之外的库，需要将库的位置添加到库的搜索路径之中。设置库文件的搜索路径有下列两种方式，可任选其中一种使用：</p>
<ul>
<li>在环境变量 <strong>LD_LIBRARY_PATH</strong> 中指明库的搜索路径</li>
<li>在 <code>/etc/ld.so.conf 文件</code>中添加库的搜索路径</li>
</ul>
<p>将自己可能存放库文件的路径都加入到 <code>/etc/ld.so.conf 目录</code> 中是明智的选择。添加方法也及其简单，将库文件的绝对路径直接写进去就OK了，一行一个。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;X11R6&#x2F;lib</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;lib</span><br><span class="line">&#x2F;opt&#x2F;lib</span><br></pre></td></tr></table></figure>

<p>也可以建一个 <code>/etc/ld.so.conf.d 目录</code>，再在这个目录下建 <code>\*.config 文件</code>并添加路径，然后在 <code>/etc/ld.so.conf 目录</code>中添加这一行： <code>include /etc/ld.so.conf.d/\*.config</code> （这样条理会清楚一点）</p>
<p>需要注意的是：第二种搜索路径的设置方式对于程序链接时的库（包括共享库和静态库）的定位已经足够了。但是对于使用了共享库的程序的执行还是不够的，这是因为为了加快程序执行时对共享库的定位速度，避免使用搜索路径查找共享库的低效率，所以是直接读取库列表文件 <code>/etc/ld.so.cache</code> 的方式从中进行搜索。<code>/etc/ld.so.cache</code> 是一个非文本的数据文件，不能直接编辑，它是根据 <code>/etc/ld.so.conf</code> 中设置的搜索路径由 <code>/sbin/ldconfig</code> 命令将这些搜索路径下的共享库文件集中在一起而生成的（ldconfig 命令要以 root 权限执行）。因此为了保证程序执行时对库的定位，在 <code>/etc/ld.so.conf</code> 中进行了库搜索路径的设置之后，还必须要运行 <code>/sbin/ldconfig</code> 命令更新 <code>/etc/ld.so.cache</code> 文件之后才可以。</p>
<p><strong>ldconfig</strong>，简单的说，它的作用就是将 <code>/etc/ld.so.conf</code> 列出的路径下的库文件缓存到 <code>/etc/ld.so.cache</code> 以供使用。因此当安装完一些库文件（例如刚安装好 glib），或者修改 <code>ld.so.conf</code> 增加新的库路径之后，需要运行一下 <code>/sbin/ldconfig</code> 使所有的库文件都被缓存到 <code>ld.so.cache</code> 中。如果没有这样做，即使库文件明明就在 <code>/usr/lib</code> 下的，也是不会被使用的，结果在编译过程中报错。</p>
<h1 id="3-pc-文件书写规范"><a href="#3-pc-文件书写规范" class="headerlink" title="3. pc 文件书写规范"></a>3. pc 文件书写规范</h1><p>这里我们首先来看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Package Information for pkg-config</span><br><span class="line"></span><br><span class="line">prefix&#x3D;&#x2F;usr&#x2F;local</span><br><span class="line">exec_prefix&#x3D;$&#123;prefix&#125;</span><br><span class="line">libdir&#x3D;$&#123;exec_prefix&#125;&#x2F;lib</span><br><span class="line">includedir&#x3D;$&#123;prefix&#125;&#x2F;include&#x2F;opencv4</span><br><span class="line"></span><br><span class="line">Name: OpenCV</span><br><span class="line">Description: Open Source Computer Vision Library</span><br><span class="line">Version: 4.5.2</span><br><span class="line">Libs: -L$&#123;exec_prefix&#125;&#x2F;lib -lopencv_stitching -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_dnn_objdetect -lopencv_dnn_superres -lopencv_dpm -lopencv_face -lopencv_fuzzy -lopencv_hdf -lopencv_hfs -lopencv_img_hash -lopencv_intensity_transform -lopencv_line_descriptor -lopencv_mcc -lopencv_quality -lopencv_rapid -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_stereo -lopencv_structured_light -lopencv_phase_unwrapping -lopencv_superres -lopencv_optflow -lopencv_surface_matching -lopencv_tracking -lopencv_highgui -lopencv_datasets -lopencv_text -lopencv_plot -lopencv_videostab -lopencv_videoio -lopencv_wechat_qrcode -lopencv_xfeatures2d -lopencv_shape -lopencv_ml -lopencv_ximgproc -lopencv_video -lopencv_dnn -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core</span><br><span class="line">Libs.private: -ldl -lm -lpthread -lrt</span><br><span class="line">Cflags: -I$&#123;includedir&#125;</span><br></pre></td></tr></table></figure>

<p>这是 opencv4.5 库的一个真实的例子。下面我们简单描述一下.pc文件中的用到的一些关键词：</p>
<ul>
<li>Name: 一个针对library或package的便于人阅读的名称。这个名称可以是任意的，它并不会影响到pkg-config的使用，pkg-config是采用pc文件名的方式来工作的。</li>
<li>Description: 对package的简短描述</li>
<li>URL: 人们可以通过该URL地址来获取package的更多信息或者package的下载地址</li>
<li>Version: 指定package版本号的字符串</li>
<li>Requires: 本库所依赖的其他库文件。所依赖的库文件的版本号可以通过使用如下比较操作符指定：=,&lt;,&gt;,&lt;=,&gt;=</li>
<li>Requires.private: 本库所依赖的一些私有库文件，但是这些私有库文件并不需要暴露给应用程序。这些私有库文件的版本指定方式与Requires中描述的类似。</li>
<li>Conflicts: 是一个可选字段，其主要用于描述与本package所冲突的其他package。版本号的描述也与Requires中的描述类似。本字段也可以取值为同一个package的多个不同版本实例。例如: Conflicts: bar &lt; 1.2.3, bar &gt;= 1.3.0</li>
<li>Cflags: 编译器编译本package时所指定的编译选项，和其他并不支持pkg-config的library的一些编译选项值。假如所需要的library支持pkg-config,则它们应该被添加到Requires或者Requires.private中</li>
<li>Libs: 链接本库时所需要的一些链接选项，和其他一些并不支持pkg-config的library的链接选项值。与Cflags类似</li>
<li>Libs.private: 本库所需要的一些私有库的链接选项。</li>
</ul>
<h1 id="4-示例"><a href="#4-示例" class="headerlink" title="4. 示例"></a>4. 示例</h1><p>我们给出一个用 <strong>pkg-config</strong> 工具协助编译的程序例子（rgb24_jpg.c）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;jpeglib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPEG_QUALITY 100 <span class="comment">//图片质量</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">save_rgb_to_jpg</span><span class="params">(<span class="keyword">char</span> *soureceData, <span class="keyword">int</span> imgWidth, <span class="keyword">int</span> imgHeight, <span class="keyword">char</span> * fileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> depth = <span class="number">3</span>;<span class="comment">//1 for gray, 3 for color</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">jpeg_compress_struct</span> <span class="title">cinfo</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">jpeg_error_mgr</span> <span class="title">jerr</span>;</span></span><br><span class="line">    FILE *outfile;                 </span><br><span class="line">    JSAMPROW row_pointer[<span class="number">1</span>];        <span class="comment">// pointer to JSAMPLE row[s] </span></span><br><span class="line">    <span class="keyword">int</span> row_stride = imgWidth;      <span class="comment">// physical row width in image buffer </span></span><br><span class="line"> </span><br><span class="line">    cinfo.err = jpeg_std_error(&amp;jerr);</span><br><span class="line">    jpeg_create_compress(&amp;cinfo);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((outfile = fopen(fileName, <span class="string">&quot;wb&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;can&#x27;t open %s\n&quot;</span>, fileName);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    jpeg_stdio_dest(&amp;cinfo, outfile);</span><br><span class="line"> </span><br><span class="line">    cinfo.image_width = imgWidth;      <span class="comment">// image width and height, in pixels </span></span><br><span class="line">    cinfo.image_height = imgHeight;</span><br><span class="line">    cinfo.input_components = depth;    <span class="comment">// of color components per pixel </span></span><br><span class="line">    cinfo.in_color_space = JCS_RGB;    <span class="comment">//or JCS_GRAYSCALE;   colorspace of input image </span></span><br><span class="line"> </span><br><span class="line">    jpeg_set_defaults(&amp;cinfo);</span><br><span class="line">    jpeg_set_quality(&amp;cinfo, JPEG_QUALITY, TRUE ); <span class="comment">/* limit to baseline-JPEG values */</span></span><br><span class="line"></span><br><span class="line">    jpeg_start_compress(&amp;cinfo, TRUE);</span><br><span class="line"> </span><br><span class="line">    row_stride = imgWidth; <span class="comment">/* JSAMPLEs per row in image_buffer */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span> (cinfo.next_scanline &lt; cinfo.image_height) </span><br><span class="line">    &#123;   </span><br><span class="line">        row_pointer[<span class="number">0</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)&amp; soureceData[cinfo.next_scanline * row_stride*depth];</span><br><span class="line">        (<span class="keyword">void</span>) jpeg_write_scanlines(&amp;cinfo, row_pointer, <span class="number">1</span>); </span><br><span class="line">    &#125;   </span><br><span class="line"> </span><br><span class="line">    jpeg_finish_compress(&amp;cinfo);</span><br><span class="line">    jpeg_destroy_compress(&amp;cinfo);  </span><br><span class="line">    fclose(outfile);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">5</span>)&#123; </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s rgbpic imgWidth imgHeight jpgpic\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">int</span> imgWidth = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">int</span> imgHeight = atoi(argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">int</span> depth = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[imgHeight * imgWidth * depth];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    read(fd, buf, <span class="keyword">sizeof</span> buf);</span><br><span class="line">    save_rgb_to_jpg(buf, atoi(argv[<span class="number">2</span>]), atoi(argv[<span class="number">3</span>]), argv[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>执行如下命令编译程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc rgb24_jpg.c -o rgb24_jpg `pkg-config --cflags --libs opencv4`</span><br></pre></td></tr></table></figure>

<p>就可以看到程序编译好了</p>
<h1 id="5-Linux下链接库的路径顺序"><a href="#5-Linux下链接库的路径顺序" class="headerlink" title="5. Linux下链接库的路径顺序"></a>5. Linux下链接库的路径顺序</h1><h2 id="5-1-运行时链接库的搜索顺序"><a href="#5-1-运行时链接库的搜索顺序" class="headerlink" title="5.1 运行时链接库的搜索顺序"></a>5.1 运行时链接库的搜索顺序</h2><p>Linux程序在运行时对动态链接库的搜索顺序如下：</p>
<p>1） 在编译目标代码时所传递的动态库搜索路径（注意，这里指的是通过 <code>-Wl,rpath=&lt;path1&gt;:&lt;path2&gt;</code> 或 <code>-R</code> 选项传递的运行时动态库搜索路径，而不是通过 <code>-L</code> 选项传递的）</p>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wl,-rpath,/home/arc/<span class="built_in">test</span>,-rpath,/lib/,-rpath,/usr/lib/,-rpath,/usr/<span class="built_in">local</span>/lib test.c</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">$ gcc -Wl,-rpath=/home/arc/<span class="built_in">test</span>:/lib/:/usr/lib/:/usr/<span class="built_in">local</span>/lib test.c</span><br></pre></td></tr></table></figure>

<p>2） 环境变量 <strong>LD_LIBRARY_PATH</strong> 指定的动态库搜索路径</p>
<p>3） 配置文件 <em>/etc/ld.so.conf</em> 中所指定的动态库搜索路径（更改 <em>/etc/ld.so.conf</em> 之后，一定要执行命令 ldconfig，该命令会将 <em>/etc/ld.so.conf</em> 文件中所有路径下的库载入内存）</p>
<p>4） 默认的动态库搜索路径 <em>/lib</em></p>
<p>5） 默认的动态库搜索路径 <em>/usr/lib</em></p>
<h2 id="5-2-编译时与运行时动态库查找的比较"><a href="#5-2-编译时与运行时动态库查找的比较" class="headerlink" title="5.2 编译时与运行时动态库查找的比较"></a>5.2 编译时与运行时动态库查找的比较</h2><p>下面是对编译时库的查找与运行时库的查找做一个简单的比较：</p>
<p>1） 编译时查找的是静态库或动态库， 而运行时，查找的是动态库</p>
<p>2） 编译时可以用 <code>-L</code> 指定查找路径，或者用环境变量 <strong>LIBRARY_PATH</strong>， 而运行时可以用 <code>-Wl,rpath</code> 或者 <code>-R</code> 选项，或者修改 <em>/etc/ld.so.conf</em>，或者设置环境变量 <strong>LD_LIBRARY_PATH</strong></p>
<p>3） 编译时用的链接器是 ld，而运行时用的链接器是 /lib/ld-linux.so.2</p>
<p>4） 编译时与运行时都会查找默认路径 <em>/lib</em>、*/usr/lib*</p>
<p>5） 编译时还有一个默认路径 <em>/usr/local/lib</em>，而运行时不会默认查找该路径</p>
<h2 id="5-3-补充-gcc使用-Wl-rpath"><a href="#5-3-补充-gcc使用-Wl-rpath" class="headerlink" title="5.3 补充:gcc使用-Wl,-rpath"></a>5.3 补充:gcc使用-Wl,-rpath</h2><p>1） <strong>-Wl,-rpath</strong></p>
<p>加上 <code>-Wl,-rpath</code> 选项的作用就是指定程序运行时的库搜索目录，是一个链接选项，生效于设置的环境变量之前(LD_LIBRARY_PATH)。下面我们通过一个例子来说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.h</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// add.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;add.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> i + j;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;add.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;1 + 2 = %d\n&quot;</span>, add(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add.h 和 add.c 用于生成一个 so 库，实现了一个简单的加法，main.c 中引用共享库计算 1 + 2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译共享库</span></span><br><span class="line">$ gcc add.c -fPIC -shared -o libadd.so</span><br><span class="line"><span class="comment"># 编译主程序</span></span><br><span class="line">$ gcc main.o -L. -ladd -o app</span><br></pre></td></tr></table></figure>

<p>编译好后运行依赖库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ldd app</span><br><span class="line">    linux-vdso.so.1 (0x00007ffeb23ab000)</span><br><span class="line">    libadd.so =&gt; not found</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007febb7dd0000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007febb83d0000</span><br><span class="line"></span><br><span class="line">$ ./app</span><br><span class="line">    ./app: error <span class="keyword">while</span> loading shared libraries: libadd.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p>可以看到， libadd.so 这个库没有找到，程序也无法运行，要运行它必须要把当前目录添加到环境变量或者搜索路径中去。但是如果在链接时加上 <code>-Wl,rpath</code> 选项之后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c -o main.o main.c</span><br><span class="line">$ gcc -Wl,-rpath=`<span class="built_in">pwd</span>` main.o -L. -ladd -o app</span><br><span class="line">$ ldd app</span><br><span class="line">linux-vdso.so.1 (0x00007fff8f4e3000)</span><br><span class="line">libadd.so =&gt; /data/code/c/1-sys/solib/libadd.so (0x00007faef8428000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007faef8030000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007faef8838000)</span><br><span class="line">$ ./app</span><br><span class="line">1 + 2 = 3</span><br></pre></td></tr></table></figure>

<p>依赖库的查找路径就找到了，程序能正常运行。</p>
<p>下面我们再来看一下生成的可执行文件app，执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d app</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xe08 contains 26 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libadd.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br><span class="line"> 0x000000000000000f (RPATH)              Library rpath: [/root/<span class="built_in">test</span>]</span><br><span class="line"> 0x000000000000000c (INIT)               0x400578</span><br><span class="line"> 0x000000000000000d (FINI)               0x400784</span><br><span class="line"> 0x0000000000000019 (INIT_ARRAY)         0x600df0</span><br><span class="line"> 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)</span><br><span class="line"> 0x000000000000001a (FINI_ARRAY)         0x600df8</span><br><span class="line"> 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)</span><br><span class="line"> 0x000000006ffffef5 (GNU_HASH)           0x400298</span><br><span class="line"> 0x0000000000000005 (STRTAB)             0x400408</span><br><span class="line"> 0x0000000000000006 (SYMTAB)             0x4002d0</span><br><span class="line"> 0x000000000000000a (STRSZ)              189 (bytes)</span><br><span class="line"> 0x000000000000000b (SYMENT)             24 (bytes)</span><br><span class="line"> 0x0000000000000015 (DEBUG)              0x0</span><br><span class="line"> 0x0000000000000003 (PLTGOT)             0x601000</span><br><span class="line"> 0x0000000000000002 (PLTRELSZ)           96 (bytes)</span><br><span class="line"> 0x0000000000000014 (PLTREL)             RELA</span><br><span class="line"> 0x0000000000000017 (JMPREL)             0x400518</span><br><span class="line"> 0x0000000000000007 (RELA)               0x400500</span><br><span class="line"> 0x0000000000000008 (RELASZ)             24 (bytes)</span><br><span class="line"> 0x0000000000000009 (RELAENT)            24 (bytes)</span><br><span class="line"> 0x000000006ffffffe (VERNEED)            0x4004e0</span><br><span class="line"> 0x000000006fffffff (VERNEEDNUM)         1</span><br><span class="line"> 0x000000006ffffff0 (VERSYM)             0x4004c6</span><br><span class="line"> 0x0000000000000000 (NULL)               0x0</span><br></pre></td></tr></table></figure>

<p>可以看到是在编译后的程序中包含了库的搜索路径。</p>
<h1 id="6-参考"><a href="#6-参考" class="headerlink" title="6. 参考"></a>6. 参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config官网</a></li>
<li><a target="_blank" rel="noopener" href="http://man.linuxde.net/ldconfig">ldconfig命令</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dyxmq.cn/linux/gcc-option-wl-rpath.html">gcc使用-Wl,-rpath解决so库版本冲突</a></li>
<li><a href="Linux%E4%B8%ADpkg-config%E7%9A%84%E4%BD%BF%E7%94%A8">Linux中pkg-config的使用</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2021/03/27/non-local_static_object_initialization/" class="prev">上一篇</a><a href="/2021/03/09/typecasting/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2021 <a href="https://codroc.github.io">Codroc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>