<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> c++ std function 要求参数有 copy constructor · Codroc Blog</title><meta name="description" content="c++ std function 要求参数有 copy constructor - Codroc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://codroc.github.io/atom.xml" title="Codroc Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Codroc Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/codroc" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">c++ std function 要求参数有 copy constructor</h1><div class="post-info">2022年8月10日</div><div class="post-content"><h1 id="std-function-默认对参数进行-copy"><a href="#std-function-默认对参数进行-copy" class="headerlink" title="std::function 默认对参数进行 copy"></a>std::function 默认对参数进行 copy</h1><p>在写线程池的时候碰到了这样的报错信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error: use of deleted function ‘std::packaged_task&lt;_Res(_ArgTypes ...)&gt;::packaged_task(const std::packaged_task&lt;_Res(_ArgTypes ...)&gt;&amp;) [with _Res &#x3D; void; _ArgTypes &#x3D; &#123;&#125;]’</span><br><span class="line"></span><br><span class="line">packaged_task(const packaged_task&amp;) &#x3D; delete;</span><br></pre></td></tr></table></figure>

<p>也就是说我的代码里调用了 <strong>packaged_task</strong> 的 copy 构造函数，但是它实际上是被删除了，因此导致编译错误；那么哪里会调用 <strong>packaged_task</strong> 的 copy 构造呢</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> Task = <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>()&gt;;</span><br><span class="line">	... ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	... ...</span><br><span class="line">    <span class="comment">// 任务队列</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">queue</span>&lt;Task&gt; _task_queue;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Function, class... Args&gt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">future</span>&lt;<span class="keyword">typename</span> <span class="built_in">std</span>::result_of&lt;Function(Args...)&gt;::type&gt;</span><br><span class="line">ThreadPool::add_task(<span class="keyword">const</span> Function&amp; f, Args... args) &#123;</span><br><span class="line">    <span class="keyword">using</span> Ret = <span class="keyword">typename</span> <span class="built_in">std</span>::result_of&lt;Function(Args...)&gt;::type;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::packaged_task&lt;<span class="title">void</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">(<span class="built_in">std</span>::bind(f, args...))</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">future</span>&lt;Ret&gt; ret = task.get_future();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(_mu)</span></span>;</span><br><span class="line">        _task_queue.push(<span class="built_in">std</span>::move(task));</span><br><span class="line">        _cv.notify_all();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <strong>_task_queue</strong> 的类型是 <code>std::queue&lt;std::function&lt;void()&gt;&gt;</code>，而 <code>std::function</code> 会对传入的参数调用 copy 构造函数，所以它的参数必须是可拷贝的（copy constructible）<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/utility/functional/function/function">cppreference</a>；<strong>然而 packaged_task 不能被 copy 只能被 move，所以会报错</strong>；</p>
<p>修改方式就是把 <code>std::queue&lt;std::function&lt;void()&gt;&gt;</code> 改成 <code>std::queue&lt;std::packaged_task&lt;void()&gt;&gt;</code> 就可以了；</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/utility/functional/function/function">cppreference——std::function</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/410001289">c++11 threadpool</a></li>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/packaged_task">cppreference——std::packaged_task</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2022/09/07/enable_if/" class="prev">上一篇</a><a href="/2022/08/09/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E6%80%BB%E7%BB%93/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://codroc.github.io">Codroc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>