<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MIT 6.824 Lab1 MapReduce · Codroc Blog</title><meta name="description" content="MIT 6.824 Lab1 MapReduce - Codroc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://codroc.github.io/atom.xml" title="Codroc Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Codroc Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/codroc" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MIT 6.824 Lab1 MapReduce</h1><div class="post-info">2022年6月10日</div><div class="post-content"><h2 id="MIT-6-824-Lab1-MapReduce"><a href="#MIT-6-824-Lab1-MapReduce" class="headerlink" title="MIT 6.824 Lab1 MapReduce"></a>MIT 6.824 Lab1 MapReduce</h2><blockquote>
<p>MapReduce is a programming model and an associated implementation for processing and generating large data sets.</p>
</blockquote>
<p>论文《MapReduce: Simplified Data Processing on Large Clusters》开篇第一句话就将明白了 <strong>MapReduce  <strong>的性质：</strong>用于处理或生成大数据的相关实现或编程模型</strong></p>
<p>如果想看论文翻译请移步 <a href="https://codroc.github.io/2022/06/06/MapReduce/">MapReduce 中文翻译</a>.</p>
<h3 id="编程模型"><a href="#编程模型" class="headerlink" title="编程模型"></a>编程模型</h3><p>整个计算过程，输入是一系列的 key/value 对，输出也是一系列的 key/value 对。这个计算过程叫做 map 与 reduce，其实就是 <strong>拆分与合并</strong>，其实很像 <strong>分而治之</strong> 的思想。</p>
<p><strong>例如：把一辆汽车拆成各种零件，再把这些零件组装成一个变形金刚。</strong></p>
<p>用户只要指定 <em>map</em> 函数和 <em>reduce</em> 函数就可以了，把剩下的交给 <strong>MapReduce 库</strong>去做就可以了。map 和 reduce 函数应该设计成这样：</p>
<ul>
<li><em>map</em> 函数接收输入的 key/value pairs，把它们变成 <em>intermediate</em> key/value pairs，MapReduce 库把所有 <em>intermediate</em> key = X （相同 key）的 pairs 集中起来传给 <em>reduce</em> 函数。</li>
<li><em>reduce</em> 函数接受 <em>intermeidate</em> key = X （相同 key）的 pairs，然后通过某一种规则把他们 merge 起来，生成较少的输出；一般 reduce 函数针对某一个 key 仅仅产生 0 个或 1 个输出。它可以处理那些很大的文件，例如在内存中放不下的文件，它可以以迭代的方式读取并去做 reduce。</li>
</ul>
<p>例如，word count 的 map 函数和 reduce 函数，用 go 就是下面这样实现的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The map function is called once for each file of input. The first</span></span><br><span class="line"><span class="comment">// argument is the name of the input file, and the second is the</span></span><br><span class="line"><span class="comment">// file&#x27;s complete contents. You should ignore the input file name,</span></span><br><span class="line"><span class="comment">// and look only at the contents argument. The return value is a slice</span></span><br><span class="line"><span class="comment">// of key/value pairs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(filename <span class="keyword">string</span>, contents <span class="keyword">string</span>)</span> []<span class="title">mr</span>.<span class="title">KeyValue</span></span> &#123;</span><br><span class="line">    <span class="comment">// function to detect word separators.</span></span><br><span class="line">    ff := <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> !unicode.IsLetter(r) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// split contents into an array of words.</span></span><br><span class="line">    words := strings.FieldsFunc(contents, ff)</span><br><span class="line"></span><br><span class="line">    kva := []mr.KeyValue&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> _, w := <span class="keyword">range</span> words &#123;</span><br><span class="line">        kv := mr.KeyValue&#123;w, <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">        kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> kva</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The reduce function is called once for each key generated by the</span></span><br><span class="line"><span class="comment">// map tasks, with a list of all the values created for that key by</span></span><br><span class="line"><span class="comment">// any map task.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reduce</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="comment">// return the number of occurrences of this word.</span></span><br><span class="line">    <span class="keyword">return</span> strconv.Itoa(<span class="built_in">len</span>(values))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析以下这个 map 和 reduce 具体是做什么的：map 函数接受一个 key/value pair，其中 key 是 filename（文件名），value 是 contents（文件内容），输出是 {word, 1} 的数组；reduce 函数接受某一个 key 的所有 value，输出是一个 value。</p>
<p><strong>那么 MapReduce 库是怎么让多个 machine 之间协同合作来一起完成 map 任务和 reduce 任务，最终完成所有任务的呢？这就要看一下 MapReduce 库的工作流程了。</strong></p>
<p><img src="https://s2.loli.net/2022/06/10/bqKmukjXd8YveT3.png" alt="MapReduce0.PNG"></p>
<p>可以看到它是一个 master 多个 worker 的模式，master 不对任务进行处理，只对 worker 进行协调，worker 去执行具体的 map task 和 reduce task。worker 会以请求任务的方式向 master 要任务去做。这种模式有以下优劣：</p>
<ul>
<li><p>把整个库分成两个部分，master 和 worker，这使得整个工作流程清晰易懂。</p>
</li>
<li><p>一个 master 而非多个 master，使得编程变得很容易，因为不需要考虑 master 之间的通信，一致性等问题；有好处就会有坏处，只有一个 master 会导致系统可用性，可靠性变差，如果 master 节点 down 了，那么整个服务就不可用了，也就是<strong>不具备容错能力</strong>；</p>
</li>
<li><p>多个 worker 使得 MapReduce 库的性能得到大大提高，处理 TB 级别的大量无依赖的数据时，将大大减少处理时间；同时将具有很好的扩展性。</p>
</li>
</ul>
<p>可不可以用一句话来概括 MapReduce 得思想？</p>
<hr>
<h3 id="用-Go-具体实现-MapReduce-库"><a href="#用-Go-具体实现-MapReduce-库" class="headerlink" title="用 Go 具体实现 MapReduce 库"></a>用 Go 具体实现 MapReduce 库</h3><ul>
<li><p>一台 machine 上分配一个 Coordinator 出来，用于协调 worker 之间的工作，并回应 worker 的任务请求。</p>
</li>
<li><p>多台 machine 上分配多个 worker 出来，向 Coordinator 索求任务（可以是 map task 也可以是 reduce task，Coordinator 给什么就做什么）。</p>
</li>
<li><p>考虑 worker 处理太慢或者突然 down 掉的情况，Coordinator 需要重新分配任务。</p>
</li>
<li><p>不考虑 Coordinator down 掉的情况。Coordinator 只会在所有任务都完成后退出，此时 Worker 与 Coordinator 的 RPC 通信会超时并返回错误，这时候就可以知道所有任务都结束了（或者 Worker 的网络状况出问题了），此时 Worker 只需要 exit 就行。</p>
</li>
</ul>
<p>Coordinator 和 Worker 分别需要哪些数据结构？</p>
<p><strong>Coordinator：</strong></p>
<ul>
<li>需要知道最终有多少个 reduce task</li>
<li>需要给 Worker 分配 id</li>
<li>需要知道当前是 map 任务还是 reduce 任务</li>
<li>需要知道是否所有任务都已经做完</li>
<li>因为某些 Worker 可能 down 掉，因此要记录哪些 Worker 正在做哪些 task，以及 Worker 的状态</li>
<li>用超时定时器判断 Worker 是否已经 down 了</li>
<li>需要记录 map task 结束后生成的所有中间结果</li>
</ul>
<p>因此最终的数据结构是这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WorkerStatus <span class="keyword">int</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Free    WorkerStatus = <span class="literal">iota</span></span><br><span class="line">    Busy</span><br><span class="line">    Timeout</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Your definitions here.</span></span><br><span class="line">    mu sync.Mutex</span><br><span class="line"></span><br><span class="line">    MapTaskFinished <span class="keyword">bool</span></span><br><span class="line">    MapTaskRemain <span class="keyword">int</span> <span class="comment">// 还剩多少 map task 任务可以分配</span></span><br><span class="line">    ReduceTaskFinished <span class="keyword">bool</span></span><br><span class="line">    ReduceTaskRemain <span class="keyword">int</span> <span class="comment">// 还剩多少 reduce task 任务可以分配</span></span><br><span class="line"></span><br><span class="line">    Workers <span class="keyword">int</span></span><br><span class="line">    WS <span class="keyword">map</span>[<span class="keyword">int</span>] WorkerStatus <span class="comment">// WorkerStatus 表示工人目前的状态，0-表示空闲，1-表示正在做任务，2-表示 coordinator 已经联系不到工人了</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// map task</span></span><br><span class="line">    WorkerToMapTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">string</span><span class="comment">// worker i 正在做 文件 filename 的 map task</span></span><br><span class="line">    IntermediateFiles []<span class="keyword">string</span></span><br><span class="line">    RecordFiles <span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">bool</span> <span class="comment">// 用于记录哪些中间文件已经出现过了</span></span><br><span class="line">    MapTask <span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">int</span> <span class="comment">// map task 需要完成的文件还有哪些, 2 表示已经完成, 1 表示还未完成, 0 表示还未分配</span></span><br><span class="line">    MapTaskBaseFilename <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// reduce task</span></span><br><span class="line">    NReduce <span class="keyword">int</span></span><br><span class="line">    WorkerToReduceTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span><span class="comment">// worker i 正在做 第 j 个 reduce task</span></span><br><span class="line">    ReduceTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span> <span class="comment">// reduce task 需要完成的任务还有哪些, 2 表示已经完成, 1 表示还未完成, 0 表示还未分配</span></span><br><span class="line">    ReduceTaskBaseFilename <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// crash</span></span><br><span class="line">    Timer <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Worker：</strong></p>
<p>其实 Worker 的很多数据都是 Coordinator 给的，因此不需要特意为他设计。</p>
<p>它的处理流程的主要结构是</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> !IsDone() &#123; <span class="comment">// 只要 Coordinator 没结束</span></span><br><span class="line">    AskTask(); <span class="comment">// 向 Coordinator 请求任务</span></span><br><span class="line">    <span class="keyword">if</span> is_map_task() &#123; <span class="comment">// 如果是 map task</span></span><br><span class="line">        <span class="keyword">if</span> has_task_to_do() &#123;</span><br><span class="line">            do_map_task()</span><br><span class="line">            reply := ReportTask() <span class="comment">// 做完任务后向 Coordinator 汇报结果</span></span><br><span class="line">            <span class="keyword">if</span> is_good_job(reply) &#123;</span><br><span class="line">                <span class="comment">// 如果 Coordinator 认可我的工作</span></span><br><span class="line">                <span class="comment">// 因为可能出现，Coordinator 以为我 down 了，把原来我的工作分配给其他人，那么我做的就是无用功了。。。</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 暂时没有任务可做，这种情况会在所有 map task 都被分配出去了，但是还没有都完成的情况下出现</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果是 reduce task</span></span><br><span class="line">        <span class="keyword">if</span> has_task_to_do() &#123;</span><br><span class="line">            do_reduce_task()</span><br><span class="line">            reply := ReportTask() <span class="comment">// 做完任务后向 Coordinator 汇报结果</span></span><br><span class="line">            <span class="keyword">if</span> is_good_job(reply) &#123;</span><br><span class="line">                <span class="comment">// 如果 Coordinator 认可我的工作</span></span><br><span class="line">                <span class="comment">// 因为可能出现，Coordinator 以为我 down 了，把原来我的工作分配给其他人，那么我做的就是无用功了。。。</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 暂时没有任务可做，这种情况会在所有 reduce task 都被分配出去了，但是还没有都完成的情况下出现</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据其主要流程就知道要设计三种 RPC 与 Coordinator 通信：</p>
<ul>
<li><p>IsDone：coordinator 是否已经完成了所有任务</p>
</li>
<li><p>AskTask：请 coordinator 给我一个任务</p>
</li>
<li><p>ReportTask：向 coordinator 汇报我完成的任务</p>
</li>
</ul>
<hr>
<p>最终代码如下：</p>
<p><code>mr/rpc.go:</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RPC definitions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// remember to capitalize all names.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// example to show how to declare the arguments</span></span><br><span class="line"><span class="comment">// and reply for an RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ExampleArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">    X <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ExampleReply <span class="keyword">struct</span> &#123;</span><br><span class="line">    Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add your RPC definitions here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AskTask: 向 coordinator 请求任务</span></span><br><span class="line"><span class="keyword">type</span> AskTaskArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">    WorkerId <span class="keyword">int</span> <span class="comment">// 当前 worker 的 id，刚开始没分配时为 nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AskTaskReply <span class="keyword">struct</span> &#123;</span><br><span class="line">    IsMapTask <span class="keyword">bool</span></span><br><span class="line">    IsReduceTask <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// map task</span></span><br><span class="line">    Filename <span class="keyword">string</span> <span class="comment">// 需要做 map 的文件名字</span></span><br><span class="line">    MapTaskBaseFilename <span class="keyword">string</span> <span class="comment">// 把 intermediate key 放到 MapTaskBaseFilename-WokerId-X 文件中去</span></span><br><span class="line">    WorkerId <span class="keyword">int</span> <span class="comment">// coordinator 分配给当前 worker 的 id，只要它还活着，除了他自己以外就没人会占用这个 id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// reduce task</span></span><br><span class="line">    NReduce <span class="keyword">int</span> <span class="comment">// 总共需要多少个 reduce</span></span><br><span class="line">    ReduceTaskBaseFilename <span class="keyword">string</span> <span class="comment">// reduce 任务的 base filename</span></span><br><span class="line">    XReduce <span class="keyword">int</span> <span class="comment">// woker 要处理第 X 个 reduce 任务，并把输出放到 ReduceTaskBaseFilename-X 中去</span></span><br><span class="line">    AllFiles []<span class="keyword">string</span> <span class="comment">// 所有的中间文件名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AskStatus: 询问 coordinator 当前的状态</span></span><br><span class="line"><span class="keyword">type</span> AskStatusArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AskStatusReply <span class="keyword">struct</span> &#123;</span><br><span class="line">    IsDone <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReportTask: worker 完成了一个任务，向 coordinator 汇报该任务完成情况</span></span><br><span class="line"><span class="keyword">type</span> ReportTaskArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">    WorkerId <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// map task</span></span><br><span class="line">    MapTaskFilename <span class="keyword">string</span></span><br><span class="line">    IntermediateFile []<span class="keyword">string</span> <span class="comment">// map 任务产生的中间文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// reduce task</span></span><br><span class="line">    XReduce <span class="keyword">int</span> <span class="comment">// worker 做的是第 XReduce 个 reduce task</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportTaskReply <span class="keyword">struct</span> &#123;</span><br><span class="line">    GoodJob <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cook up a unique-ish UNIX-domain socket name</span></span><br><span class="line"><span class="comment">// in /var/tmp, for the coordinator.</span></span><br><span class="line"><span class="comment">// Can&#x27;t use the current directory since</span></span><br><span class="line"><span class="comment">// Athena AFS doesn&#x27;t support UNIX-domain sockets.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">coordinatorSock</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;/var/tmp/824-mr-&quot;</span></span><br><span class="line">    s += strconv.Itoa(os.Getuid())</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>mr/coordinator.go:</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WorkerStatus <span class="keyword">int</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Free    WorkerStatus = <span class="literal">iota</span></span><br><span class="line">    Busy</span><br><span class="line">    Timeout</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Your definitions here.</span></span><br><span class="line">    mu sync.Mutex</span><br><span class="line"></span><br><span class="line">    MapTaskFinished <span class="keyword">bool</span></span><br><span class="line">    MapTaskRemain <span class="keyword">int</span> <span class="comment">// 还剩多少 map task 任务可以分配</span></span><br><span class="line">    ReduceTaskFinished <span class="keyword">bool</span></span><br><span class="line">    ReduceTaskRemain <span class="keyword">int</span> <span class="comment">// 还剩多少 reduce task 任务可以分配</span></span><br><span class="line"></span><br><span class="line">    Workers <span class="keyword">int</span></span><br><span class="line">    WS <span class="keyword">map</span>[<span class="keyword">int</span>] WorkerStatus <span class="comment">// WorkerStatus 表示工人目前的状态，0-表示空闲，1-表示正在做任务，2-表示 coordinator 已经联系不到工人了</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// map task</span></span><br><span class="line">    WorkerToMapTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">string</span><span class="comment">// worker i 正在做 文件 filename 的 map task</span></span><br><span class="line">    IntermediateFiles []<span class="keyword">string</span></span><br><span class="line">    RecordFiles <span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">bool</span> <span class="comment">// 用于记录哪些中间文件已经出现过了</span></span><br><span class="line">    MapTask <span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">int</span> <span class="comment">// map task 需要完成的文件还有哪些, 2 表示已经完成, 1 表示还未完成, 0 表示还未分配</span></span><br><span class="line">    MapTaskBaseFilename <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// reduce task</span></span><br><span class="line">    NReduce <span class="keyword">int</span></span><br><span class="line">    WorkerToReduceTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span><span class="comment">// worker i 正在做 第 j 个 reduce task</span></span><br><span class="line">    ReduceTask <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span> <span class="comment">// reduce task 需要完成的任务还有哪些, 2 表示已经完成, 1 表示还未完成, 0 表示还未分配</span></span><br><span class="line">    ReduceTaskBaseFilename <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// crash</span></span><br><span class="line">    Timer <span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your code here -- RPC handlers for the worker to call.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// an example RPC handler.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// the RPC argument and reply types are defined in rpc.go.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">Example</span><span class="params">(args *ExampleArgs, reply *ExampleReply)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    reply.Y = args.X + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">IsDone</span><span class="params">(args *AskStatusArgs, reply *AskStatusReply)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// 由于 Done 是线程安全的，因此 IsDone 也是线程安全的</span></span><br><span class="line">    reply.IsDone = c.Done()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">AskTask</span><span class="params">(args *AskTaskArgs, reply *AskTaskReply)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.WorkerId == <span class="number">-1</span> &#123;</span><br><span class="line">        args.WorkerId = c.Workers</span><br><span class="line">        c.Workers++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="comment">// 分配任务</span></span><br><span class="line">    worker_id := args.WorkerId</span><br><span class="line">    reply.WorkerId = worker_id</span><br><span class="line">    reply.NReduce = c.NReduce</span><br><span class="line">    reply.XReduce = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !c.MapTaskFinished &#123;</span><br><span class="line">        reply.IsMapTask = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">for</span> filename, val := <span class="keyword">range</span> c.MapTask &#123;</span><br><span class="line">            <span class="keyword">if</span> val == <span class="number">0</span> &#123;</span><br><span class="line">                reply.Filename = filename</span><br><span class="line">                reply.MapTaskBaseFilename = c.MapTaskBaseFilename</span><br><span class="line">                c.MapTask[filename] = <span class="number">1</span></span><br><span class="line">                c.WorkerToMapTask[worker_id] = filename</span><br><span class="line">                c.WS[worker_id] = Busy</span><br><span class="line">                c.Timer[worker_id] = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !c.ReduceTaskFinished &#123;</span><br><span class="line">        reply.IsReduceTask = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">for</span> xreduce, val := <span class="keyword">range</span> c.ReduceTask &#123;</span><br><span class="line">            <span class="keyword">if</span> val == <span class="number">0</span> &#123;</span><br><span class="line">                reply.XReduce = xreduce</span><br><span class="line">                reply.ReduceTaskBaseFilename = c.ReduceTaskBaseFilename</span><br><span class="line">                reply.AllFiles = c.IntermediateFiles</span><br><span class="line">                c.ReduceTask[xreduce] = <span class="number">1</span></span><br><span class="line">                c.WorkerToReduceTask[worker_id] = xreduce</span><br><span class="line">                c.WS[worker_id] = Busy</span><br><span class="line">                c.Timer[worker_id] = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">is_timeout</span><span class="params">(worker_id <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> c.WS[worker_id] == Timeout</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">ReportTask</span><span class="params">(args *ReportTaskArgs, reply *ReportTaskReply)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    worker_id := args.WorkerId</span><br><span class="line">    <span class="comment">// 如果超时了则不理他</span></span><br><span class="line">    <span class="keyword">if</span>  c.is_timeout(worker_id) &#123;</span><br><span class="line">        reply.GoodJob = <span class="literal">false</span></span><br><span class="line">        c.WS[worker_id] = Free</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !c.MapTaskFinished &#123;</span><br><span class="line">        <span class="keyword">if</span> c.WorkerToMapTask[worker_id] == args.MapTaskFilename &amp;&amp; c.WS[worker_id] == Busy &#123;</span><br><span class="line">            reply.GoodJob = <span class="literal">true</span></span><br><span class="line">            c.WS[worker_id] = Free</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> _, intermediate_file := <span class="keyword">range</span> args.IntermediateFile &#123;</span><br><span class="line">                <span class="comment">// 如果中间文件没有出现过，那么就把他加入 IntermediateFiles 中，并把他记录下了，用于去重</span></span><br><span class="line">                _, ok := c.RecordFiles[intermediate_file]</span><br><span class="line">                <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                    c.IntermediateFiles = <span class="built_in">append</span>(c.IntermediateFiles, intermediate_file)</span><br><span class="line">                    c.RecordFiles[intermediate_file] = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            c.MapTask[args.MapTaskFilename] = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            c.MapTaskRemain--</span><br><span class="line">            <span class="keyword">if</span> c.MapTaskRemain == <span class="number">0</span> &#123;</span><br><span class="line">                c.MapTaskFinished = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !c.ReduceTaskFinished&#123;</span><br><span class="line">        <span class="keyword">if</span> c.WorkerToReduceTask[worker_id] == args.XReduce &amp;&amp; c.WS[worker_id] == Busy &#123;</span><br><span class="line">            reply.GoodJob = <span class="literal">true</span></span><br><span class="line">            c.WS[worker_id] = Free</span><br><span class="line"></span><br><span class="line">            c.ReduceTask[args.XReduce] = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            c.ReduceTaskRemain--</span><br><span class="line">            <span class="keyword">if</span> c.ReduceTaskRemain == <span class="number">0</span> &#123;</span><br><span class="line">                c.ReduceTaskFinished = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 所有任务都已经完成了</span></span><br><span class="line">        reply.GoodJob = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// worker 向我汇报了，但他汇报的任务和我发布的不同或者他在 free 或 timeout 状态</span></span><br><span class="line">    <span class="comment">// 但他既然向我汇报了，那么他一定是 Free 的</span></span><br><span class="line">    c.WS[worker_id] = Free</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// start a thread that listens for RPCs from worker.go</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">server</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rpc.Register(c)</span><br><span class="line">    rpc.HandleHTTP()</span><br><span class="line">    <span class="comment">//l, e := net.Listen(&quot;tcp&quot;, &quot;:1234&quot;)</span></span><br><span class="line">    sockname := coordinatorSock()</span><br><span class="line">    os.Remove(sockname)</span><br><span class="line">    l, e := net.Listen(<span class="string">&quot;unix&quot;</span>, sockname)</span><br><span class="line">    <span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(<span class="string">&quot;listen error:&quot;</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">go</span> http.Serve(l, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// main/mrcoordinator.go calls Done() periodically to find out</span></span><br><span class="line"><span class="comment">// if the entire job has finished.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">Done</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    ret := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.MapTaskFinished &amp;&amp; c.ReduceTaskFinished &#123;</span><br><span class="line">        ret = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> worker_id, _ := <span class="keyword">range</span> c.Timer &#123;</span><br><span class="line">        c.Timer[worker_id]++</span><br><span class="line">        <span class="keyword">if</span> c.Timer[worker_id] &gt;= <span class="number">10</span> &amp;&amp; c.WS[worker_id] == Busy &#123;</span><br><span class="line">            c.WS[worker_id] = Timeout</span><br><span class="line">            <span class="keyword">if</span> !c.MapTaskFinished &#123;</span><br><span class="line">                map_task := c.WorkerToMapTask[worker_id]</span><br><span class="line">                c.WorkerToMapTask[worker_id] = <span class="string">&quot;&quot;</span></span><br><span class="line">                c.MapTask[map_task] = <span class="number">0</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> !c.ReduceTaskFinished &#123;</span><br><span class="line">                reduce_task := c.WorkerToReduceTask[worker_id]</span><br><span class="line">                c.WorkerToReduceTask[worker_id] = <span class="number">-1</span></span><br><span class="line">                c.ReduceTask[reduce_task] = <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// create a Coordinator.</span></span><br><span class="line"><span class="comment">// main/mrcoordinator.go calls this function.</span></span><br><span class="line"><span class="comment">// nReduce is the number of reduce tasks to use.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCoordinator</span><span class="params">(files []<span class="keyword">string</span>, nReduce <span class="keyword">int</span>)</span> *<span class="title">Coordinator</span></span> &#123;</span><br><span class="line">    c := Coordinator&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line"></span><br><span class="line">    c.MapTaskRemain = <span class="built_in">len</span>(files)</span><br><span class="line">    c.ReduceTaskRemain = nReduce</span><br><span class="line">    c.NReduce = nReduce</span><br><span class="line"></span><br><span class="line">    c.MapTask = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">    c.ReduceTask = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">    c.WS = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>] WorkerStatus)</span><br><span class="line">    c.WorkerToMapTask = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">string</span>)</span><br><span class="line">    c.IntermediateFiles = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">    c.RecordFiles = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">bool</span>)</span><br><span class="line">    c.WorkerToReduceTask = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span>)</span><br><span class="line">    c.Timer = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>] <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">    c.MapTaskBaseFilename = <span class="string">&quot;mr&quot;</span></span><br><span class="line">    c.ReduceTaskBaseFilename = <span class="string">&quot;mr-out&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">        c.MapTask[file] = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx := <span class="number">0</span>; idx &lt; nReduce; idx++ &#123;</span><br><span class="line">        c.ReduceTask[idx] = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.server()</span><br><span class="line">    <span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>mr/worker.go:</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;hash/fnv&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;os&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;strconv&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;strings&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;sort&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"> <span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// Map functions return a slice of KeyValue.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="keyword">type</span> KeyValue <span class="keyword">struct</span> &#123;</span><br><span class="line">     Key   <span class="keyword">string</span></span><br><span class="line">     Value <span class="keyword">string</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// for sorting by key.</span></span><br><span class="line"> <span class="keyword">type</span> ByKey []KeyValue</span><br><span class="line"></span><br><span class="line"> <span class="comment">// for sorting by key.</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(a) &#125;</span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; a[i], a[j] = a[j], a[i] &#125;</span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> a[i].Key &lt; a[j].Key &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// use ihash(key) % NReduce to choose the reduce</span></span><br><span class="line"> <span class="comment">// task number for each KeyValue emitted by Map.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">ihash</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">     h := fnv.New32a()</span><br><span class="line">     h.Write([]<span class="keyword">byte</span>(key))</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">int</span>(h.Sum32() &amp; <span class="number">0x7fffffff</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">is_map_task</span><span class="params">(task AskTaskReply)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">     <span class="keyword">return</span> task.IsMapTask</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> <span class="comment">// main/mrworker.go calls this function.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapf <span class="keyword">func</span>(<span class="keyword">string</span>, <span class="keyword">string</span>)</span> []<span class="title">KeyValue</span>,</span></span><br><span class="line">     reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">string</span>, []<span class="keyword">string</span>)</span> <span class="title">string</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Your worker implementation here.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// uncomment to send the Example RPC to the coordinator.</span></span><br><span class="line">     <span class="comment">// CallExample()</span></span><br><span class="line">     <span class="comment">// 如果 mr 任务还没结束</span></span><br><span class="line">     <span class="keyword">var</span> nreduce <span class="keyword">int</span></span><br><span class="line">     worker_id := <span class="number">-1</span></span><br><span class="line">     total_map := <span class="number">0</span></span><br><span class="line">     total_reduce := <span class="number">0</span></span><br><span class="line">     <span class="keyword">for</span> !IsDone() &#123;</span><br><span class="line">         <span class="comment">// 向 coordinator 要任务</span></span><br><span class="line">         task := AskTask(worker_id)</span><br><span class="line">         worker_id = task.WorkerId</span><br><span class="line">         nreduce = task.NReduce</span><br><span class="line">         buckets := <span class="built_in">make</span>([][]KeyValue, nreduce) <span class="comment">// nreduce 个 kva</span></span><br><span class="line">         <span class="keyword">if</span> is_map_task(task) &#123;</span><br><span class="line">             filename := task.Filename</span><br><span class="line">             <span class="keyword">if</span> filename != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                 file, err := os.Open(filename)</span><br><span class="line">                 <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                     log.Fatalf(<span class="string">&quot;Can not open file %v ai&quot;</span>, filename)</span><br><span class="line">                 &#125;</span><br><span class="line">                 content, err := ioutil.ReadAll(file)</span><br><span class="line">                 file.Close()</span><br><span class="line">                 <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                     log.Fatalf(<span class="string">&quot;Can not read file %v&quot;</span>, filename)</span><br><span class="line">                 &#125;</span><br><span class="line">                 kva := mapf(filename, <span class="keyword">string</span>(content))</span><br><span class="line">                 <span class="keyword">for</span> _, item := <span class="keyword">range</span> kva &#123;</span><br><span class="line">                     bucket_number := ihash(item.Key) % nreduce</span><br><span class="line">                     buckets[bucket_number] = <span class="built_in">append</span>(buckets[bucket_number], item);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">// 对 buckets 中的 item 排序</span></span><br><span class="line">                 <span class="keyword">for</span> _, bucket := <span class="keyword">range</span> buckets &#123;</span><br><span class="line">                     sort.Sort(ByKey(bucket))</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 intermediate_files := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">                 basename := task.MapTaskBaseFilename + <span class="string">&quot;-&quot;</span> + strconv.Itoa(worker_id)</span><br><span class="line">                 <span class="keyword">for</span> index, bucket := <span class="keyword">range</span> buckets &#123;</span><br><span class="line">                     <span class="comment">// TODO</span></span><br><span class="line">                     <span class="comment">// 创建一个临时文件，把 bucket 中的内容写入临时文件中，并在完成任务后通过 ReportTask 向 coordinator 汇报该任务，</span></span><br><span class="line">                     <span class="comment">// 当收到 coordinator 的确认后再把临时文件转正</span></span><br><span class="line">                     oname := basename + <span class="string">&quot;-&quot;</span> + strconv.Itoa(total_map) + <span class="string">&quot;-&quot;</span> + strconv.Itoa(index)</span><br><span class="line">                     intermediate_files = <span class="built_in">append</span>(intermediate_files, oname)</span><br><span class="line">                     ofile, _ := os.OpenFile(oname, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, <span class="number">0666</span>)</span><br><span class="line">                     enc := json.NewEncoder(ofile)</span><br><span class="line">                     <span class="keyword">for</span> _, item := <span class="keyword">range</span> bucket &#123;</span><br><span class="line">                         err := enc.Encode(&amp;item)</span><br><span class="line">                         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                             log.Fatalf(<span class="string">&quot;json encoding error!\n&quot;</span>)</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     ofile.Close()</span><br><span class="line">                 &#125;</span><br><span class="line">                 reply := ReportTask(worker_id, task.Filename, intermediate_files, task.XReduce)</span><br><span class="line">                 <span class="keyword">if</span> reply.GoodJob &#123;</span><br><span class="line">                     total_map++</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">// 暂时没任务，其他 worker 正在做 map task</span></span><br><span class="line">                 time.Sleep(time.Second)</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// reduce task</span></span><br><span class="line">             <span class="keyword">if</span> task.XReduce != <span class="number">-1</span> &#123;</span><br><span class="line">                 intermediate := []KeyValue&#123;&#125;</span><br><span class="line">                 <span class="keyword">for</span> _, file := <span class="keyword">range</span> task.AllFiles &#123;</span><br><span class="line">                     ss := strings.Split(file, <span class="string">&quot;-&quot;</span>)</span><br><span class="line">                     sxreduce := ss[<span class="built_in">len</span>(ss) - <span class="number">1</span>]</span><br><span class="line">                     xreduce, _ := strconv.Atoi(sxreduce)</span><br><span class="line">                     <span class="keyword">if</span> xreduce == task.XReduce &#123;</span><br><span class="line">                         f, _ := os.Open(file)</span><br><span class="line">                         dec := json.NewDecoder(f)</span><br><span class="line">                         <span class="keyword">for</span> &#123;</span><br><span class="line">                             <span class="keyword">var</span> kv KeyValue</span><br><span class="line">                             <span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                                 <span class="keyword">break</span></span><br><span class="line">                             &#125;</span><br><span class="line">                             intermediate = <span class="built_in">append</span>(intermediate, kv)</span><br><span class="line">                         &#125;</span><br><span class="line">                         f.Close()</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 sort.Sort(ByKey(intermediate))</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 输出到 ReduceTaskBaseFilename-X 去</span></span><br><span class="line">                 oname := task.ReduceTaskBaseFilename + <span class="string">&quot;-&quot;</span> + strconv.Itoa(task.XReduce)</span><br><span class="line">                 ofile, err := os.OpenFile(<span class="string">&quot;tmp&quot;</span> + oname + <span class="string">&quot;.tmp&quot;</span>, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, <span class="number">0666</span>)</span><br><span class="line">                 <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                     log.Fatalf(<span class="string">&quot;Can not open %v\n&quot;</span>, oname)</span><br><span class="line">                 &#125;</span><br><span class="line">                 i := <span class="number">0</span></span><br><span class="line">                 <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) &#123;</span><br><span class="line">                     j := i + <span class="number">1</span></span><br><span class="line">                     values := []<span class="keyword">string</span>&#123;intermediate[i].Value&#125;</span><br><span class="line">                     <span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key &#123;</span><br><span class="line">                         values = <span class="built_in">append</span>(values, intermediate[j].Value)</span><br><span class="line">                         j++</span><br><span class="line">                     &#125;</span><br><span class="line">                     output := reducef(intermediate[i].Key, values)</span><br><span class="line">                     fmt.Fprintf(ofile, <span class="string">&quot;%v %v\n&quot;</span>, intermediate[i].Key, output)</span><br><span class="line">                     i = j</span><br><span class="line">                 &#125;</span><br><span class="line">                 ofile.Close()</span><br><span class="line">                 reply := ReportTask(worker_id, task.Filename, <span class="literal">nil</span>, task.XReduce)</span><br><span class="line">                 <span class="keyword">if</span> reply.GoodJob &#123;</span><br><span class="line">                     total_reduce++</span><br><span class="line">                     tmpfile, _ := os.OpenFile(<span class="string">&quot;tmp&quot;</span> + oname + <span class="string">&quot;.tmp&quot;</span>, os.O_RDONLY|os.O_CREATE|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">                     realfile, _ := os.OpenFile(oname, os.O_WRONLY|os.O_CREATE|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">                     content, _ := ioutil.ReadAll(tmpfile)</span><br><span class="line">                     realfile.Write(content)</span><br><span class="line">                     realfile.Close()</span><br><span class="line">                     tmpfile.Close()</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">// 暂时没有 reduce task 可做，其他 worker 正在做</span></span><br><span class="line">                 time.Sleep(time.Second)</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// example function to show how to make an RPC call to the coordinator.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// the RPC argument and reply types are defined in rpc.go.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">CallExample</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// declare an argument structure.</span></span><br><span class="line">     args := ExampleArgs&#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// fill in the argument(s).</span></span><br><span class="line">     args.X = <span class="number">99</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// declare a reply structure.</span></span><br><span class="line">     reply := ExampleReply&#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// send the RPC request, wait for the reply.</span></span><br><span class="line">     call(<span class="string">&quot;Coordinator.Example&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line"></span><br><span class="line">     <span class="comment">// reply.Y should be 100.</span></span><br><span class="line">     fmt.Printf(<span class="string">&quot;reply.Y %v\n&quot;</span>, reply.Y)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// coordinator 是否已经完成了所有任务</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">IsDone</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">     args := AskStatusArgs&#123;&#125;</span><br><span class="line">     reply := AskStatusReply&#123;&#125;</span><br><span class="line">     connect := call(<span class="string">&quot;Coordinator.IsDone&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line">     <span class="keyword">if</span> !connect &#123;</span><br><span class="line">         <span class="comment">// coordinator 已经退出了，因为所有任务都已经完成了</span></span><br><span class="line">         <span class="comment">// fmt.Printf(&quot;Coordinator is down!\n&quot;)</span></span><br><span class="line">         os.Exit(<span class="number">0</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> reply.IsDone</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 请 coordinator 给我一个任务</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">AskTask</span><span class="params">(worker_id <span class="keyword">int</span>)</span> <span class="title">AskTaskReply</span></span> &#123;</span><br><span class="line">     args := AskTaskArgs&#123;&#125;</span><br><span class="line">     args.WorkerId = worker_id</span><br><span class="line">     reply := AskTaskReply&#123;&#125;</span><br><span class="line">     <span class="comment">// why? 解除下面这条注释，就会出现问题。。。。迷惑</span></span><br><span class="line">     <span class="comment">// reply.XReduce = -1 // 表示没有 reduce task 可做</span></span><br><span class="line">     connect := call(<span class="string">&quot;Coordinator.AskTask&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line">     <span class="keyword">if</span> !connect &#123;</span><br><span class="line">         <span class="comment">// coordinator 已经退出了，因为所有任务都已经完成了</span></span><br><span class="line">         os.Exit(<span class="number">0</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> reply</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 向 coordinator 汇报我完成的任务</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">ReportTask</span><span class="params">(worker_id <span class="keyword">int</span>, filename <span class="keyword">string</span>, intermediate_files []<span class="keyword">string</span>, xreduce <span class="keyword">int</span>)</span> <span class="title">ReportTaskReply</span></span> &#123;</span><br><span class="line">     args := ReportTaskArgs&#123;&#125;</span><br><span class="line">     args.WorkerId = worker_id</span><br><span class="line">     args.MapTaskFilename = filename</span><br><span class="line">     args.IntermediateFile = intermediate_files</span><br><span class="line">     args.XReduce = xreduce</span><br><span class="line"></span><br><span class="line">     reply := ReportTaskReply&#123;&#125;</span><br><span class="line"></span><br><span class="line">     connect := call(<span class="string">&quot;Coordinator.ReportTask&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line">     <span class="keyword">if</span> !connect &#123;</span><br><span class="line">         <span class="comment">// coordinator 已经退出了，因为所有任务都已经完成了</span></span><br><span class="line">         os.Exit(<span class="number">0</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> reply</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// send an RPC request to the coordinator, wait for the response.</span></span><br><span class="line"> <span class="comment">// usually returns true.</span></span><br><span class="line"> <span class="comment">// returns false if something goes wrong.</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(rpcname <span class="keyword">string</span>, args <span class="keyword">interface</span>&#123;&#125;, reply <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">     <span class="comment">// c, err := rpc.DialHTTP(&quot;tcp&quot;, &quot;127.0.0.1&quot;+&quot;:1234&quot;)</span></span><br><span class="line">     sockname := coordinatorSock()</span><br><span class="line">     c, err := rpc.DialHTTP(<span class="string">&quot;unix&quot;</span>, sockname)</span><br><span class="line">     <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         log.Fatal(<span class="string">&quot;dialing:&quot;</span>, err)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">defer</span> c.Close()</span><br><span class="line"></span><br><span class="line">     err = c.Call(rpcname, args, reply)</span><br><span class="line">     <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     fmt.Println(err)</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/2022/06/14/rw_file_by_json/" class="prev">上一篇</a><a href="/2022/06/06/MapReduce/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://codroc.github.io">Codroc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>